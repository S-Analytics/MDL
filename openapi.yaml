openapi: 3.0.3
info:
  title: Metrics Definition Library (MDL) API
  description: |
    The Metrics Definition Library API provides a comprehensive system for managing metric definitions,
    objectives, key results, and generating OPA (Open Policy Agent) policies for governance.
    
    This API supports creating, reading, updating, and deleting metric definitions with rich metadata
    including alignment, data sources, governance, targets, alerts, and operational usage information.
  version: 1.1.0
  contact:
    name: MDL API Support
    email: support@example.com
  x-api-features:
    - Semantic versioning for metrics (MAJOR.MINOR.PATCH)
    - Automatic change history tracking
    - PostgreSQL JSONB metadata storage
    - OPA policy generation
    - Enhanced reporting with version history
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000
    description: Local development server
  - url: http://0.0.0.0:3000
    description: Local server (all interfaces)

tags:
  - name: Health
    description: Health check endpoints
  - name: Metrics
    description: Metric definition operations
  - name: Policies
    description: OPA policy generation
  - name: Statistics
    description: Metrics statistics and aggregations
  - name: PostgreSQL
    description: PostgreSQL database operations for metrics, domains, and objectives
  - name: Domains
    description: Business domain operations
  - name: Objectives
    description: Objective and key results operations

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check if the API server is running and healthy
      operationId: healthCheck
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                    example: '2025-11-14T10:30:00.000Z'

  /api/metrics:
    get:
      tags:
        - Metrics
      summary: Get all metrics
      description: Retrieve all metric definitions with optional filtering
      operationId: getAllMetrics
      parameters:
        - name: business_domain
          in: query
          description: Filter by business domain
          required: false
          schema:
            type: string
            example: Authentication
        - name: metric_type
          in: query
          description: Filter by metric type
          required: false
          schema:
            type: string
            example: operational
        - name: tier
          in: query
          description: Filter by tier
          required: false
          schema:
            type: string
            enum: [Tier-1, Tier-2, Tier-3]
            example: Tier-1
        - name: tags
          in: query
          description: Filter by tags (comma-separated)
          required: false
          schema:
            type: string
            example: security,authentication
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/MetricDefinition'
                  count:
                    type: integer
                    example: 10
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Metrics
      summary: Create a new metric
      description: |
        Create a new metric definition. The metric will be initialized with:
        - Version 1.0.0
        - Created timestamp and user
        - Initial change history entry
        
        The system automatically tracks all changes with semantic versioning.
      operationId: createMetric
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MetricDefinitionInput'
      responses:
        '201':
          description: Metric created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/MetricDefinition'
        '400':
          description: Bad request - missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Missing required fields: name, description'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/metrics/{id}:
    get:
      tags:
        - Metrics
      summary: Get metric by ID
      description: Retrieve a specific metric definition by its ID
      operationId: getMetricById
      parameters:
        - name: id
          in: path
          required: true
          description: Metric ID
          schema:
            type: string
            example: METRIC-LOGIN-SUCCESS-RATE
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/MetricDefinition'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Metrics
      summary: Update a metric
      description: |
        Update an existing metric definition. The system automatically:
        - Calculates appropriate version bump (MAJOR/MINOR/PATCH)
        - Adds change history entry with modified fields
        - Updates last_updated timestamp and user
        
        Version bumping logic:
        - **MAJOR** (X.0.0): Changes to formula, unit, category, definition
        - **MINOR** (x.X.0): Changes to name, description, tier, business_domain
        - **PATCH** (x.x.X): Changes to tags, metadata, visualization
      operationId: updateMetric
      parameters:
        - name: id
          in: path
          required: true
          description: Metric ID
          schema:
            type: string
            example: METRIC-LOGIN-SUCCESS-RATE
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MetricDefinitionInput'
      responses:
        '200':
          description: Metric updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/MetricDefinition'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Metrics
      summary: Delete a metric
      description: Delete a metric definition
      operationId: deleteMetric
      parameters:
        - name: id
          in: path
          required: true
          description: Metric ID
          schema:
            type: string
            example: METRIC-LOGIN-SUCCESS-RATE
      responses:
        '200':
          description: Metric deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Metric deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/metrics/{id}/policy:
    get:
      tags:
        - Policies
      summary: Generate OPA policy for a metric
      description: Generate an Open Policy Agent (OPA) policy for a specific metric
      operationId: getMetricPolicy
      parameters:
        - name: id
          in: path
          required: true
          description: Metric ID
          schema:
            type: string
            example: METRIC-LOGIN-SUCCESS-RATE
      responses:
        '200':
          description: OPA policy generated successfully
          content:
            text/plain:
              schema:
                type: string
                example: |
                  package metrics.login_success_rate
                  
                  default allow = false
                  
                  allow {
                    input.metric_id == "METRIC-LOGIN-SUCCESS-RATE"
                    input.value >= 0.95
                  }
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/policies:
    get:
      tags:
        - Policies
      summary: Generate OPA policies for all metrics
      description: Generate a bundle of OPA policies for all metrics in the system
      operationId: getAllPolicies
      responses:
        '200':
          description: Policy bundle generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    additionalProperties:
                      type: string
                    example:
                      login_success_rate.rego: |
                        package metrics.login_success_rate
                        default allow = false
                  count:
                    type: integer
                    example: 5
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/import:
    post:
      tags:
        - Metrics
        - Domains
        - Objectives
      summary: Universal import for all data types
      description: |
        Automatically detects and imports metrics, business domains, or objectives from template files.
        
        **Supported Formats:**
        - Single metric, domain, or objective object
        - Array of metrics, domains, or objectives  
        - Wrapped format with metrics, domains, and/or objectives arrays
        - Mixed files with multiple data types
        
        **Auto-Detection:**
        - Metrics identified by metric_id, name, description, category
        - Domains identified by id (becomes domain_id), name, stakeholders
        - Objectives identified by objective_id, title, key_results
        
        **Storage Routing:**
        - Metrics → File storage or PostgreSQL
        - Domains → PostgreSQL (requires dbConfig)
        - Objectives → PostgreSQL (requires dbConfig)
      operationId: universalImport
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - data
              properties:
                data:
                  description: Data to import - system auto-detects type
                  oneOf:
                    - type: object
                      description: Single item or wrapped items
                    - type: array
                      description: Array of items
                      items:
                        type: object
                dbConfig:
                  description: PostgreSQL config (required for domains/objectives)
                  type: object
                  properties:
                    host:
                      type: string
                    port:
                      type: integer
                    database:
                      type: string
                    user:
                      type: string
                    password:
                      type: string
      responses:
        '200':
          description: Import completed with results
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      type:
                        type: string
                        enum: [metrics, domains, objectives, mixed]
                        description: Detected data type
                      imported:
                        type: object
                        properties:
                          metrics:
                            type: integer
                          domains:
                            type: integer
                          objectives:
                            type: integer
                          errors:
                            type: array
                            items:
                              type: string
                      total:
                        type: integer
                        description: Total items imported successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/stats:
    get:
      tags:
        - Statistics
      summary: Get metrics statistics
      description: Get aggregated statistics about all metrics in the system
      operationId: getStats
      responses:
        '200':
          description: Statistics retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      total:
                        type: integer
                        description: Total number of metrics
                        example: 25
                      byTier:
                        type: object
                        additionalProperties:
                          type: integer
                        example:
                          Tier-1: 5
                          Tier-2: 15
                          Tier-3: 5
                      byMetricType:
                        type: object
                        additionalProperties:
                          type: integer
                        example:
                          operational: 10
                          business: 8
                          technical: 7
                      byBusinessDomain:
                        type: object
                        additionalProperties:
                          type: integer
                        example:
                          Authentication: 5
                          Performance: 8
                          Revenue: 12
                      byOwner:
                        type: object
                        additionalProperties:
                          type: integer
                        example:
                          john.doe@example.com: 10
                          jane.smith@example.com: 15
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/postgres/metrics:
    post:
      tags:
        - PostgreSQL
      summary: Fetch metrics from PostgreSQL
      description: Retrieve all metrics from PostgreSQL database
      operationId: fetchPostgresMetrics
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PostgresConfig'
      responses:
        '200':
          description: Metrics retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/MetricDefinition'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/postgres/metrics/save:
    post:
      tags:
        - PostgreSQL
      summary: Save metric to PostgreSQL
      description: |
        Create or update a metric in PostgreSQL database.
        
        The metric's metadata (including version history) is stored in a JSONB column,
        allowing efficient querying and indexing of version information.
        
        When updating an existing metric, the system automatically calculates the
        appropriate version bump and adds a change history entry.
      operationId: savePostgresMetric
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - dbConfig
                - metric
                - isUpdate
              properties:
                dbConfig:
                  $ref: '#/components/schemas/PostgresConfig'
                metric:
                  $ref: '#/components/schemas/MetricDefinition'
                isUpdate:
                  type: boolean
                  description: Whether this is an update (true) or create (false) operation
                  example: true
      responses:
        '200':
          description: Metric saved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/MetricDefinition'
        '400':
          description: Bad request - missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/postgres/metrics/delete:
    post:
      tags:
        - PostgreSQL
      summary: Delete metric from PostgreSQL
      description: Delete a metric from PostgreSQL database
      operationId: deletePostgresMetric
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - dbConfig
                - metricId
              properties:
                dbConfig:
                  $ref: '#/components/schemas/PostgresConfig'
                metricId:
                  type: string
                  example: METRIC-LOGIN-SUCCESS-RATE
      responses:
        '200':
          description: Metric deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/postgres/domains:
    post:
      tags:
        - PostgreSQL
      summary: Fetch domains from PostgreSQL
      description: Retrieve all business domains from PostgreSQL database
      operationId: fetchPostgresDomains
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PostgresConfig'
      responses:
        '200':
          description: Domains retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/BusinessDomain'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/postgres/domains/save:
    post:
      tags:
        - PostgreSQL
      summary: Save domain to PostgreSQL
      description: Create or update a business domain in PostgreSQL database
      operationId: savePostgresDomain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - dbConfig
                - domain
                - isUpdate
              properties:
                dbConfig:
                  $ref: '#/components/schemas/PostgresConfig'
                domain:
                  $ref: '#/components/schemas/BusinessDomain'
                isUpdate:
                  type: boolean
                  description: Whether this is an update (true) or create (false) operation
                  example: false
      responses:
        '200':
          description: Domain saved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/BusinessDomain'
        '400':
          description: Bad request - missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/postgres/domains/delete:
    post:
      tags:
        - PostgreSQL
      summary: Delete domain from PostgreSQL
      description: Delete a business domain from PostgreSQL database
      operationId: deletePostgresDomain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - dbConfig
                - domainId
              properties:
                dbConfig:
                  $ref: '#/components/schemas/PostgresConfig'
                domainId:
                  type: string
                  example: auth-5678
      responses:
        '200':
          description: Domain deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/postgres/objectives:
    post:
      tags:
        - PostgreSQL
      summary: Fetch objectives from PostgreSQL
      description: Retrieve all objectives with key results from PostgreSQL database
      operationId: fetchPostgresObjectives
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PostgresConfig'
      responses:
        '200':
          description: Objectives retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Objective'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/postgres/objectives/save:
    post:
      tags:
        - PostgreSQL
      summary: Save objective to PostgreSQL
      description: Create or update an objective with key results in PostgreSQL database
      operationId: savePostgresObjective
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - dbConfig
                - objective
                - isUpdate
              properties:
                dbConfig:
                  $ref: '#/components/schemas/PostgresConfig'
                objective:
                  $ref: '#/components/schemas/Objective'
                isUpdate:
                  type: boolean
                  description: Whether this is an update (true) or create (false) operation
                  example: true
      responses:
        '200':
          description: Objective saved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Objective'
        '400':
          description: Bad request - missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/postgres/objectives/delete:
    post:
      tags:
        - PostgreSQL
      summary: Delete objective from PostgreSQL
      description: Delete an objective and its key results from PostgreSQL database (CASCADE)
      operationId: deletePostgresObjective
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - dbConfig
                - objectiveId
              properties:
                dbConfig:
                  $ref: '#/components/schemas/PostgresConfig'
                objectiveId:
                  type: string
                  example: OBJ-20251115041315
      responses:
        '200':
          description: Objective deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/database/test:
    post:
      tags:
        - PostgreSQL
      summary: Test database connection
      description: Test the connection to PostgreSQL database
      operationId: testDatabaseConnection
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PostgresConfig'
      responses:
        '200':
          description: Connection test successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: PostgreSQL connection successful
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  schemas:
    MetricDefinition:
      type: object
      required:
        - metric_id
        - name
        - short_name
        - description
        - category
        - tier
        - business_domain
        - metric_type
        - tags
        - alignment
        - definition
        - data
        - governance
        - dimensions
        - targets_and_alerts
        - visualization
        - relationships
        - operational_usage
        - metadata
      properties:
        metric_id:
          type: string
          description: Unique identifier for the metric
          example: METRIC-LOGIN-SUCCESS-RATE
        name:
          type: string
          description: Full name of the metric
          example: Login Success Rate
        short_name:
          type: string
          description: Short name or code for the metric
          example: login_success_rate
        description:
          type: string
          description: Detailed description of the metric
          example: Percentage of successful login attempts
        category:
          type: string
          description: Category of the metric
          example: Authentication
        tier:
          type: string
          description: Importance tier of the metric
          enum: [Tier-1, Tier-2, Tier-3]
          example: Tier-1
        business_domain:
          type: string
          description: Business domain the metric belongs to
          example: Authentication
        metric_type:
          type: string
          description: Type of metric
          example: operational
        tags:
          type: array
          items:
            type: string
          description: Tags for categorization
          example: [security, authentication, user-experience]
        alignment:
          $ref: '#/components/schemas/Alignment'
        definition:
          $ref: '#/components/schemas/Definition'
        data:
          $ref: '#/components/schemas/DataInfo'
        governance:
          $ref: '#/components/schemas/GovernanceInfo'
        dimensions:
          type: array
          items:
            $ref: '#/components/schemas/Dimension'
        targets_and_alerts:
          $ref: '#/components/schemas/TargetsAndAlerts'
        visualization:
          $ref: '#/components/schemas/Visualization'
        relationships:
          $ref: '#/components/schemas/Relationships'
        operational_usage:
          $ref: '#/components/schemas/OperationalUsage'
        metadata:
          $ref: '#/components/schemas/MetricMetadata'

    MetricDefinitionInput:
      type: object
      required:
        - name
        - description
        - category
        - dataType
      properties:
        name:
          type: string
          example: Login Success Rate
        description:
          type: string
          example: Percentage of successful login attempts
        category:
          type: string
          example: Authentication
        dataType:
          type: string
          enum: [number, percentage, currency, count, ratio, duration, boolean, string]
          example: percentage
        unit:
          type: string
          example: percent
        tags:
          type: array
          items:
            type: string
          example: [security, authentication]
        validationRules:
          type: array
          items:
            $ref: '#/components/schemas/ValidationRule'
        governance:
          $ref: '#/components/schemas/GovernanceInfo'
        source:
          type: string
          example: authentication_service
        metadata:
          type: object
          additionalProperties: true

    Alignment:
      type: object
      properties:
        strategic_pillar:
          type: string
          example: User Experience Excellence
        primary_objective_ids:
          type: array
          items:
            type: string
          example: [OBJ-001]
        related_okr_ids:
          type: array
          items:
            type: string
          example: [KR-001, KR-002]
        why_it_matters:
          type: string
          example: High login success rates indicate a frictionless authentication experience

    Definition:
      type: object
      properties:
        formula:
          type: string
          example: (successful_logins / total_login_attempts) * 100
        formula_detail:
          type: string
          example: Successful logins divided by total login attempts, multiplied by 100
        numerator:
          $ref: '#/components/schemas/EventDefinition'
        denominator:
          $ref: '#/components/schemas/EventDefinition'
        unit:
          type: string
          example: percent
        expected_direction:
          type: string
          enum: [increase, decrease]
          example: increase
        example_calculation:
          type: object
          additionalProperties:
            type: number
          example:
            successful_logins: 950
            total_login_attempts: 1000
            result: 95.0

    EventDefinition:
      type: object
      properties:
        event_name:
          type: string
          example: user_login
        filters:
          type: array
          items: {}
          example: [{ status: 'success' }]

    DataInfo:
      type: object
      properties:
        primary_sources:
          type: array
          items:
            $ref: '#/components/schemas/DataSource'
        secondary_sources:
          type: array
          items:
            $ref: '#/components/schemas/DataSource'
        data_freshness:
          type: string
          example: 5 minutes
        update_frequency:
          type: string
          example: real-time
        time_grain:
          type: array
          items:
            type: string
          example: [minute, hour, day]
        data_retention:
          type: string
          example: 90_days

    DataSource:
      type: object
      properties:
        system:
          type: string
          example: authentication_service
        table_or_stream:
          type: string
          example: auth_events
        connection_id:
          type: string
          example: prod-db-001

    GovernanceInfo:
      type: object
      properties:
        data_classification:
          type: string
          example: internal
        pii_involved:
          type: boolean
          example: false
        regulatory_constraints:
          type: array
          items:
            type: string
          example: [SOC2, GDPR]
        owner_team:
          type: string
          example: Platform Team
        technical_owner:
          type: string
          example: john.doe@example.com
        business_owner:
          type: string
          example: jane.smith@example.com
        version:
          type: string
          example: 1.0.0
        status:
          type: string
          example: active
        created_at:
          type: string
          format: date-time
          example: '2025-01-01T00:00:00.000Z'
        updated_at:
          type: string
          format: date-time
          example: '2025-11-14T10:30:00.000Z'

    Dimension:
      type: object
      properties:
        name:
          type: string
          example: region
        allowed_values:
          type: array
          items:
            type: string
          example: [us-east, us-west, eu-central]
        required:
          type: boolean
          example: true

    TargetsAndAlerts:
      type: object
      properties:
        target_value:
          type: number
          example: 95
        warning_threshold:
          type: number
          example: 90
        critical_threshold:
          type: number
          example: 85
        comparison_baseline:
          type: string
          example: previous_period
        alert_rules:
          type: array
          items:
            $ref: '#/components/schemas/AlertRule'

    AlertRule:
      type: object
      properties:
        rule_id:
          type: string
          description: Unique identifier for the alert rule
          example: ALERT-001
        condition:
          type: string
          description: Condition that triggers the alert
          example: metric_value < warning_threshold
        severity:
          type: string
          enum: [critical, warning, info]
          description: Severity level of the alert
          example: warning
        notify_channels:
          type: array
          description: Channels to notify when alert fires (legacy field)
          items:
            type: string
          example: [slack, email, pagerduty]
        notification_channels:
          type: array
          description: Channels to notify when alert fires (preferred field)
          items:
            type: string
          example: ["slack:#alerts", "email:oncall@example.com", "pagerduty"]
        evaluation_window:
          type: string
          description: Time window for evaluating the alert condition
          example: 5 minutes

    Visualization:
      type: object
      properties:
        default_chart_type:
          type: string
          example: line
        default_time_range:
          type: string
          example: last_30_days
        dashboard_locations:
          type: array
          items:
            $ref: '#/components/schemas/DashboardLocation'
        drilldowns:
          type: array
          items:
            type: string
          example: [region, device_type]

    DashboardLocation:
      type: object
      properties:
        tool:
          type: string
          example: Grafana
        url:
          type: string
          example: https://grafana.example.com/dashboard/auth-metrics

    Relationships:
      type: object
      properties:
        upstream_metric_ids:
          type: array
          items:
            type: string
          example: [METRIC-AUTH-ATTEMPTS]
        downstream_metric_ids:
          type: array
          items:
            type: string
          example: [METRIC-USER-SATISFACTION]
        tradeoffs:
          type: array
          items:
            type: string
          example: [Stricter security may reduce success rate]

    OperationalUsage:
      type: object
      properties:
        decision_use_cases:
          type: array
          items:
            type: string
          example: [Authentication system health monitoring]
        review_cadence:
          type: string
          example: weekly
        linked_playbooks:
          type: array
          items:
            $ref: '#/components/schemas/Playbook'

    Playbook:
      type: object
      properties:
        name:
          type: string
          example: Low Login Success Rate Response
        url:
          type: string
          example: https://docs.example.com/playbooks/auth-issues

    MetricMetadata:
      type: object
      required:
        - version
        - created_at
        - created_by
        - last_updated
        - last_updated_by
        - change_history
      properties:
        notes:
          type: string
          description: Additional notes about the metric
          example: Monitor closely during authentication system changes
        example_queries:
          type: array
          description: Example queries for calculating the metric
          items:
            $ref: '#/components/schemas/ExampleQuery'
        version:
          type: string
          description: Semantic version following MAJOR.MINOR.PATCH format
          pattern: '^\d+\.\d+\.\d+$'
          example: "1.2.3"
        created_at:
          type: string
          format: date-time
          description: Timestamp when the metric was first created
          example: "2025-11-18T10:00:00.000Z"
        created_by:
          type: string
          description: User who created the metric
          example: "dashboard_user"
        last_updated:
          type: string
          format: date-time
          description: Timestamp of the last update
          example: "2025-11-18T15:30:00.000Z"
        last_updated_by:
          type: string
          description: User who last updated the metric
          example: "api_user"
        change_history:
          type: array
          description: Complete audit trail of all changes to the metric
          items:
            $ref: '#/components/schemas/ChangeHistoryEntry'

    ExampleQuery:
      type: object
      properties:
        language:
          type: string
          example: SQL
        query:
          type: string
          example: SELECT COUNT(*) FROM auth_events WHERE status = 'success'

    ChangeHistoryEntry:
      type: object
      required:
        - version
        - timestamp
        - changed_by
        - change_type
        - changes_summary
        - fields_changed
      properties:
        version:
          type: string
          description: Version at the time of this change
          pattern: '^\d+\.\d+\.\d+$'
          example: "1.2.0"
        timestamp:
          type: string
          format: date-time
          description: When the change occurred
          example: "2025-11-18T15:30:00.000Z"
        changed_by:
          type: string
          description: User who made the change
          example: "dashboard_user"
        change_type:
          type: string
          enum: [major, minor, patch]
          description: |
            Type of change based on semantic versioning:
            - **major**: Breaking changes (formula, definition, data sources)
            - **minor**: New features or significant updates (name, targets, dimensions)
            - **patch**: Bug fixes or minor updates (tags, metadata, visualization)
          example: "minor"
        changes_summary:
          type: string
          description: Human-readable summary of what changed
          example: "Updated targets and alert thresholds"
        fields_changed:
          type: array
          description: Array of field names that were modified
          items:
            type: string
          example: ["targets_and_alerts", "dimensions"]

    ValidationRule:
      type: object
      properties:
        type:
          type: string
          enum: [min, max, range, required, pattern, enum]
          example: min
        value:
          oneOf:
            - type: number
            - type: string
            - type: array
          example: 0
        message:
          type: string
          example: Value must be greater than 0

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: Error message

    PostgresConfig:
      type: object
      required:
        - host
        - port
        - name
        - user
      properties:
        host:
          type: string
          description: PostgreSQL host address
          example: localhost
        port:
          type: string
          description: PostgreSQL port number
          example: "5432"
        name:
          type: string
          description: Database name
          example: mdl_db
        user:
          type: string
          description: Database user
          example: postgres
        password:
          type: string
          description: Database password
          example: password123

    BusinessDomain:
      type: object
      required:
        - domain_id
        - name
        - description
      properties:
        domain_id:
          type: string
          description: Unique identifier for the domain
          example: auth-5678
        name:
          type: string
          description: Name of the business domain
          example: Authentication & Authorization
        description:
          type: string
          description: Detailed description of the domain
          example: Core systems managing user authentication, authorization, and access control
        owner_team:
          type: string
          description: Team responsible for this domain
          example: Platform Security Team
        contact_email:
          type: string
          format: email
          description: Contact email for the domain owner
          example: security-team@example.com
        tier_focus:
          type: string
          enum: [Tier-1, Tier-2, Tier-3, Mixed]
          description: Primary tier focus of the domain
          example: Tier-1
        key_areas:
          type: array
          items:
            type: string
          description: Key areas covered by this domain
          example: [User Login, OAuth2, MFA, Session Management]
        color:
          type: string
          description: Color code for UI representation
          example: "#FF5722"
        created_at:
          type: string
          format: date-time
          description: Timestamp when domain was created
          example: "2025-11-14T10:30:00.000Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when domain was last updated
          example: "2025-11-14T10:30:00.000Z"

    Objective:
      type: object
      required:
        - objective_id
        - name
        - description
        - business_domain
        - tier
        - key_results
      properties:
        objective_id:
          type: string
          description: Unique identifier for the objective
          example: OBJ-20251115041315
        name:
          type: string
          description: Name of the objective
          example: Improve Authentication Experience
        description:
          type: string
          description: Detailed description of the objective
          example: Enhance user authentication to be faster and more reliable
        business_domain:
          type: string
          description: Business domain this objective belongs to
          example: Authentication & Authorization
        tier:
          type: string
          enum: [Tier-1, Tier-2, Tier-3]
          description: Importance tier of the objective
          example: Tier-1
        quarter:
          type: string
          description: Target quarter for the objective
          example: Q1 2025
        owner:
          type: string
          description: Owner of the objective
          example: john.doe@example.com
        target_value:
          type: number
          description: Target value to achieve
          example: 95
        current_value:
          type: number
          description: Current value
          example: 85
        start_date:
          type: string
          format: date
          description: Start date of the objective
          example: "2025-01-01"
        end_date:
          type: string
          format: date
          description: End date of the objective
          example: "2025-03-31"
        status:
          type: string
          enum: [not_started, in_progress, at_risk, completed]
          description: Current status of the objective
          example: in_progress
        progress:
          type: number
          description: Progress percentage (0-100)
          example: 60
        key_results:
          type: array
          description: Key results associated with this objective
          items:
            $ref: '#/components/schemas/KeyResult'
        created_at:
          type: string
          format: date-time
          description: Timestamp when objective was created
          example: "2025-11-14T10:30:00.000Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when objective was last updated
          example: "2025-11-14T10:30:00.000Z"

    KeyResult:
      type: object
      required:
        - kr_id
        - objective_id
        - name
        - description
        - metric_ids
      properties:
        kr_id:
          type: string
          description: Unique identifier for the key result
          example: OBJ-20251115041315:KR-1
        objective_id:
          type: string
          description: ID of the parent objective
          example: OBJ-20251115041315
        name:
          type: string
          description: Name of the key result
          example: Increase Login Success Rate
        description:
          type: string
          description: Detailed description of the key result
          example: Improve the percentage of successful login attempts to 95% or higher
        metric_ids:
          type: array
          items:
            type: string
          description: IDs of metrics associated with this key result
          example: [METRIC-LOGIN-SUCCESS-RATE]
        target_value:
          type: number
          description: Target value to achieve
          example: 95
        current_value:
          type: number
          description: Current value
          example: 85
        unit:
          type: string
          description: Unit of measurement
          example: percent
        status:
          type: string
          enum: [not_started, on_track, at_risk, achieved]
          description: Current status of the key result
          example: on_track
        weight:
          type: number
          description: Weight/importance of this key result (0-100)
          example: 40
        created_at:
          type: string
          format: date-time
          description: Timestamp when key result was created
          example: "2025-11-14T10:30:00.000Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when key result was last updated
          example: "2025-11-14T10:30:00.000Z"

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: Metric not found

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: Internal server error
